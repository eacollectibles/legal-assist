---
/**
 * [...slug].astro - Dynamic page handler with SERVER-SIDE SEO
 * 
 * PERFORMANCE OPTIMIZATIONS:
 * - Critical font preloading
 * - DNS prefetch for external resources
 * - Preconnect for critical origins
 * - Deferred non-critical scripts
 * - Optimized resource hints
 */
import AppRouter from "@/components/Router";
import { seoConfig, businessInfo, generateFAQSchema, generateBreadcrumbSchema } from "@/components/seoConfig";
import { PHONE_TEL } from "@/lib/contact";
import "@wix/wix-vibe-plugins/plugins-vars.css";
import "@wix/wix-vibe-plugins/plugins-theme.css";
import "@/styles/global.css";

// Get the current path from Astro
const pathname = Astro.url.pathname;

// Normalize path (remove trailing slash except for root)
const normalizedPath = pathname === '/' ? '/' : pathname.replace(/\/$/, '');

// Check if this is a private route (noindex)
const isPrivateRoute = /^\/(admin|dashboard|login|signup|intake|booking|upload)/.test(normalizedPath);

// Get SEO config for this path, or use defaults
const pageConfig = seoConfig[normalizedPath] || {
  title: 'LegalAssist Paralegal Services | London Ontario',
  description: 'Licensed paralegal services in London, Ontario. Traffic tickets, landlord-tenant disputes, small claims court, human rights tribunal. Free consultation. Call 365-882-9515.',
  keywords: 'paralegal london ontario, legal services, traffic ticket lawyer, LTB paralegal, small claims court'
};

// Build canonical URL
const canonicalUrl = `${businessInfo.url}${normalizedPath === '/' ? '' : normalizedPath}`;

// Generate JSON-LD for FAQs if present
const faqSchema = pageConfig.faqs && pageConfig.faqs.length > 0 
  ? generateFAQSchema(pageConfig.faqs) 
  : null;

// Generate JSON-LD for breadcrumbs if present
const breadcrumbSchema = pageConfig.breadcrumbs && pageConfig.breadcrumbs.length > 0 
  ? generateBreadcrumbSchema(pageConfig.breadcrumbs, businessInfo.url) 
  : null;

// Schema.org structured data
const schemaData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": ["LegalService", "LocalBusiness", "ProfessionalService"],
      "@id": "https://www.legalassist.london/#organization",
      "name": "LegalAssist Paralegal Services",
      "alternateName": "LegalAssist",
      "description": "Licensed paralegal services in London, Ontario. Affordable representation for Small Claims Court (up to $50,000), Landlord Tenant Board, traffic tickets, Human Rights Tribunal, and provincial offences throughout Southwestern Ontario.",
      "url": "https://www.legalassist.london",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.legalassist.london/logo.png",
        "width": 512,
        "height": 512
      },
      "image": "https://www.legalassist.london/og-image.jpg",
      "telephone": PHONE_TEL,
      "email": "info@legalassist.london",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "P.O Box 1000",
        "addressLocality": "London",
        "addressRegion": "ON",
        "postalCode": "N6A 2L1",
        "addressCountry": "CA"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": 42.9849,
        "longitude": -81.2453
      },
      "areaServed": [
        { "@type": "City", "name": "London" },
        { "@type": "AdministrativeArea", "name": "Middlesex County" },
        { "@type": "AdministrativeArea", "name": "Elgin County" },
        { "@type": "AdministrativeArea", "name": "Oxford County" },
        { "@type": "AdministrativeArea", "name": "Southwestern Ontario" },
        { "@type": "AdministrativeArea", "name": "Ontario" }
      ],
      "openingHoursSpecification": [
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
          "opens": "09:00",
          "closes": "18:00"
        },
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": "Saturday",
          "opens": "10:00",
          "closes": "14:00"
        }
      ],
      "priceRange": "$",
      "currenciesAccepted": "CAD",
      "paymentAccepted": ["Cash", "Credit Card", "Debit Card", "Interac e-Transfer"],
      "knowsLanguage": ["en", "English"],
      "slogan": "Affordable Legal Help When You Need It Most",
      "foundingDate": "2024",
      "legalName": "LegalAssist Paralegal Services"
    },
    {
      "@type": "WebSite",
      "@id": "https://www.legalassist.london/#website",
      "url": "https://www.legalassist.london",
      "name": "LegalAssist Paralegal Services",
      "description": "Licensed paralegal services in London, Ontario",
      "publisher": {
        "@id": "https://www.legalassist.london/#organization"
      },
      "inLanguage": "en-CA"
    },
    {
      "@type": "ContactPoint",
      "@id": "https://www.legalassist.london/#contact",
      "telephone": PHONE_TEL,
      "contactType": "customer service",
      "availableLanguage": "English",
      "areaServed": "CA-ON"
    }
  ]
};

const currentYear = new Date().getFullYear();
---

<html lang="en" class="w-full h-full">
  <head>
    <!-- Basic charset and viewport -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta httpEquiv="X-UA-Compatible" content="IE=edge" />
    
    <!-- ============================================
         PERFORMANCE: Critical Resource Hints
         ============================================ -->
    
    <!-- Preload critical fonts (eliminates FOIT) -->
    <link 
      rel="preload" 
      href="/fonts/dmsans/v17/rP2Hp2ywxg089UriCZOIHTWEBlw.woff2" 
      as="font" 
      type="font/woff2" 
      crossorigin="anonymous"
    />
    <link 
      rel="preload" 
      href="/fonts/playfairdisplay/v40/nuFiD-vYSZviVYUb_rj3ij__anPXDTzYgEM86xQ.woff2" 
      as="font" 
      type="font/woff2" 
      crossorigin="anonymous"
    />
    
    <!-- DNS Prefetch for external resources -->
    <link rel="dns-prefetch" href="https://static.wixstatic.com" />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    
    <!-- Preconnect for critical third-party origins -->
    <link rel="preconnect" href="https://static.parastorage.com" crossorigin="anonymous" />
    
    <!-- SERVER-SIDE SEO: Title -->
    <title>{pageConfig.title}</title>
    
    <!-- SERVER-SIDE SEO: Description -->
    <meta name="description" content={pageConfig.description} />
    
    <!-- SERVER-SIDE SEO: Keywords -->
    {pageConfig.keywords && <meta name="keywords" content={pageConfig.keywords} />}
    
    <!-- SERVER-SIDE SEO: Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- SERVER-SIDE SEO: Robots directive -->
    <meta name="robots" content={isPrivateRoute ? 'noindex, nofollow' : 'index, follow'} />
    
    <!-- Business Meta -->
    <meta name="author" content="LegalAssist Paralegal Services" />
    <meta name="publisher" content="LegalAssist Paralegal Services" />
    <meta name="copyright" content={`© ${currentYear} LegalAssist Paralegal Services`} />
    <meta name="language" content="en-CA" />
    
    <!-- SERVER-SIDE SEO: Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="LegalAssist Paralegal Services" />
    <meta property="og:title" content={pageConfig.title} />
    <meta property="og:description" content={pageConfig.description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:locale" content="en_CA" />
    <meta property="og:image" content={`${businessInfo.url}/og-image.jpg`} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="LegalAssist Paralegal Services - London, Ontario" />
    
    <!-- SERVER-SIDE SEO: Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageConfig.title} />
    <meta name="twitter:description" content={pageConfig.description} />
    <meta name="twitter:image" content={`${businessInfo.url}/og-image.jpg`} />
    
    <!-- SERVER-SIDE SEO: Geo tags -->
    <meta name="geo.region" content="CA-ON" />
    <meta name="geo.placename" content="London, Ontario" />
    <meta name="geo.position" content="42.9849;-81.2453" />
    <meta name="ICBM" content="42.9849, -81.2453" />
    
    <!-- Theme and PWA -->
    <meta name="theme-color" content="#B94A1F" />
    <meta name="msapplication-TileColor" content="#B94A1F" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="LegalAssist" />
    <meta name="application-name" content="LegalAssist" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- Security -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
    
    <!-- SERVER-SIDE SEO: FAQ Schema if present -->
    {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
    
    <!-- SERVER-SIDE SEO: Breadcrumb Schema if present -->
    {breadcrumbSchema && <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />}
    
    <!-- ============================================
         PERFORMANCE: Critical CSS (Inline)
         Prevents render-blocking for above-the-fold content
         ============================================ -->
    <style is:inline>
      /* Critical CSS - Above the fold styles */
      html{opacity:0;visibility:hidden;background-color:#F9F5F0}
      html.hydrated{opacity:1;visibility:visible;transition:opacity .15s ease-in-out}
      body{margin:0;font-family:'DM Sans',system-ui,-apple-system,sans-serif;background-color:#F9F5F0;color:#4A2C23}
      .bg-background{background-color:#F9F5F0}
      .text-secondary{color:#4A2C23}
      .text-primary{color:#B94A1F}
      .font-heading{font-family:'Playfair Display',Georgia,serif}
      .font-paragraph{font-family:'DM Sans',system-ui,sans-serif}
      /* Loading skeleton */
      .skeleton-pulse{animation:pulse 1.5s cubic-bezier(.4,0,.6,1) infinite}
      @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
      /* Prevent layout shift */
      #root{min-height:100vh;display:flex;flex-direction:column}
    </style>
  </head>
  <body class="w-full h-full">
    <!-- ============================================
         SERVER-RENDERED SEO CONTENT
         This HTML is visible to Google on first crawl.
         Hidden once React hydrates. Users see the React app.
         ============================================ -->
    <div id="ssr-content" class="w-full bg-background text-secondary font-paragraph">
      <header class="max-w-4xl mx-auto px-4 py-6">
        <a href="/" class="text-primary font-heading font-bold text-2xl no-underline">LegalAssist Paralegal Services</a>
        <nav class="mt-4" aria-label="Main navigation">
          <ul class="flex flex-wrap gap-4 list-none p-0 m-0">
            <li><a href="/" class="text-secondary hover:text-primary no-underline">Home</a></li>
            <li><a href="/services" class="text-secondary hover:text-primary no-underline">Services</a></li>
            <li><a href="/services/traffic-tickets" class="text-secondary hover:text-primary no-underline">Traffic Tickets</a></li>
            <li><a href="/services/landlord-tenant-board" class="text-secondary hover:text-primary no-underline">Landlord &amp; Tenant</a></li>
            <li><a href="/services/small-claims" class="text-secondary hover:text-primary no-underline">Small Claims</a></li>
            <li><a href="/services/human-rights-tribunal" class="text-secondary hover:text-primary no-underline">Human Rights</a></li>
            <li><a href="/about" class="text-secondary hover:text-primary no-underline">About</a></li>
            <li><a href="/contact" class="text-secondary hover:text-primary no-underline">Contact</a></li>
          </ul>
        </nav>
      </header>

      <main class="max-w-4xl mx-auto px-4 py-8">
        {/* Breadcrumbs */}
        {pageConfig.breadcrumbs && pageConfig.breadcrumbs.length > 0 && (
          <nav aria-label="Breadcrumb" class="mb-6">
            <ol class="flex flex-wrap gap-2 list-none p-0 m-0 text-sm">
              {pageConfig.breadcrumbs.map((crumb: any, i: number) => (
                <li class="flex items-center gap-2">
                  {i > 0 && <span aria-hidden="true">/</span>}
                  <a href={crumb.url} class="text-primary no-underline">{crumb.name}</a>
                </li>
              ))}
            </ol>
          </nav>
        )}

        {/* Page heading and description */}
        <h1 class="font-heading text-3xl md:text-4xl text-secondary mb-4">{pageConfig.title.split('|')[0].trim()}</h1>
        <p class="text-lg text-secondary/80 mb-8 leading-relaxed">{pageConfig.description}</p>

        {/* Service info */}
        {pageConfig.schema && pageConfig.schema.serviceType && (
          <section class="mb-8">
            <h2 class="font-heading text-2xl text-secondary mb-3">Our Service</h2>
            <p class="text-secondary/80">{pageConfig.schema.name || pageConfig.schema.serviceType} — serving {pageConfig.schema.areaServed ? pageConfig.schema.areaServed.join(', ') : 'London and Southwestern Ontario'}.</p>
          </section>
        )}

        {/* SSR Content Sections - Rich content for Google */}
        {pageConfig.contentSections && pageConfig.contentSections.length > 0 && (
          pageConfig.contentSections.map((section: any) => (
            <section class="mb-8">
              <h2 class="font-heading text-2xl text-secondary mb-3">{section.heading}</h2>
              <p class="text-secondary/80 leading-relaxed">{section.content}</p>
            </section>
          ))
        )}

        {/* CTA */}
        <section class="mb-8 p-6 bg-primary/5 rounded-lg">
          <h2 class="font-heading text-2xl text-secondary mb-3">Free Consultation</h2>
          <p class="text-secondary/80 mb-4">Call <a href={`tel:${businessInfo.telephone}`} class="text-primary font-semibold no-underline">{businessInfo.telephoneDisplay}</a> or <a href="/contact" class="text-primary font-semibold no-underline">book online</a> to speak with a licensed paralegal at no obligation.</p>
        </section>

        {/* FAQs rendered as real HTML */}
        {pageConfig.faqs && pageConfig.faqs.length > 0 && (
          <section class="mb-8">
            <h2 class="font-heading text-2xl text-secondary mb-6">Frequently Asked Questions</h2>
            {pageConfig.faqs.map((faq: any) => (
              <div class="mb-6">
                <h3 class="font-heading text-xl text-secondary mb-2">{faq.question}</h3>
                <p class="text-secondary/80 leading-relaxed">{faq.answer}</p>
              </div>
            ))}
          </section>
        )}

        {/* Contact info block */}
        <section class="mb-8">
          <h2 class="font-heading text-2xl text-secondary mb-3">Contact LegalAssist</h2>
          <p class="text-secondary/80">
            <strong>Phone:</strong> <a href={`tel:${businessInfo.telephone}`} class="text-primary no-underline">{businessInfo.telephoneDisplay}</a><br/>
            <strong>Email:</strong> <a href={`mailto:${businessInfo.email}`} class="text-primary no-underline">{businessInfo.email}</a><br/>
            <strong>Location:</strong> {businessInfo.address.addressLocality}, {businessInfo.address.addressRegion} {businessInfo.address.postalCode}<br/>
            <strong>Hours:</strong> Monday–Friday 9:00 AM – 6:00 PM
          </p>
        </section>
      </main>

      <footer class="max-w-4xl mx-auto px-4 py-6 border-t border-secondary/10">
        <p class="text-sm text-secondary/60">© {currentYear} LegalAssist Paralegal Services. Licensed by the Law Society of Ontario. Serving London and Southwestern Ontario.</p>
      </footer>
    </div>

    <!-- Loading indicator (shows while JS loads) -->
    <div id="loading-indicator" class="fixed inset-0 bg-background z-[9999] flex items-center justify-center" aria-hidden="true" style="display:none;">
      <div class="flex flex-col items-center gap-4">
        <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
          <span class="text-primary font-heading font-bold text-xl">LA</span>
        </div>
        <div class="w-32 h-1 bg-secondary/10 rounded-full overflow-hidden">
          <div class="h-full bg-primary rounded-full" style="animation: loading 1s ease-in-out infinite; width: 30%;"></div>
        </div>
      </div>
      <style>
        @keyframes loading {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(400%); }
        }
      </style>
    </div>
    
    <div id="root" class="w-full h-full bg-background" style="display:none;">
      <AppRouter client:only="react" />
    </div>
    
    <script>
      // CRITICAL: Fast hydration marker
      const markHydrated = () => {
        document.documentElement.classList.add('hydrated');
        
        // Hide SSR content, show React app
        const ssr = document.getElementById('ssr-content');
        const root = document.getElementById('root');
        const loader = document.getElementById('loading-indicator');
        
        if (ssr) ssr.style.display = 'none';
        if (root) root.style.display = '';
        if (loader) {
          loader.style.display = 'flex';
          loader.style.opacity = '0';
          loader.style.transition = 'opacity 0.2s ease-out';
          setTimeout(() => loader.remove(), 200);
        }
      };
      
      // Wait for React to actually mount before swapping
      const observer = new MutationObserver(() => {
        const root = document.getElementById('root');
        if (root && root.children.length > 1) {
          markHydrated();
          observer.disconnect();
        }
      });
      observer.observe(document.getElementById('root') || document.body, { childList: true, subtree: true });
      
      // Fallback: if React hasn't mounted in 5s, swap anyway
      setTimeout(() => {
        if (!document.documentElement.classList.contains('hydrated')) {
          console.warn('[Hydration] Fallback triggered');
          markHydrated();
        }
      }, 5000);
    </script>
    
    <!-- Prefetch likely navigation targets -->
    <link rel="prefetch" href="/services" />
    <link rel="prefetch" href="/contact" />
  </body>
</html>
